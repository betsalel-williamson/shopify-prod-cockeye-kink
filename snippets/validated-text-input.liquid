{%- comment %}
  1. Create unique IDs for our form, input, and error elements
     based on the section ID.
{%- endcomment %}
{%- assign form_id = 'product-form-' | append: section.id -%}
{%- assign input_id = 'custom-engraving-' | append: section.id -%}
{%- assign error_id = 'engraving-error-' | append: section.id -%}

<div style="margin-bottom:15px;">
  <label for="{{ input_id }}">Engraving (5 chars max, A-Z, 0-9):</label>

  <input
    type="text"
    id="{{ input_id }}"
    name="properties[Engraving]"
    maxlength="5"
    pattern="[a-zA-Z0-9]*"
    title="Only letters (A-Z) and numbers (0-9) are allowed."
    style="width: 100%; border: 1px solid #ccc; padding: 8px; border-radius: 4px; box-sizing: border-box;"
    form="{{ form_id }}"
  >

  <div id="{{ error_id }}" style="color: #d9534f; display: none; margin-top: 5px; font-size: 0.9em;">
    Please use only 5 characters (letters and numbers).
  </div>
</div>

<script>
  // --- THIS IS THE FIX ---
  // Wait for the entire HTML document to be loaded and parsed
  // before we try to find any elements.
  document.addEventListener('DOMContentLoaded', function () {
    // Get the unique IDs we created in Liquid
    const formId = '{{ form_id }}';
    const inputId = '{{ input_id }}';
    const errorId = '{{ error_id }}';

    // Now, find the elements by their unique IDs
    const productForm = document.getElementById(formId);
    const customInput = document.getElementById(inputId);
    const errorMsg = document.getElementById(errorId);

    // Check if all elements were found
    if (!productForm) {
      console.warn('Custom validation: Could not find form with ID:', formId);
      return;
    }
    if (!customInput || !errorMsg) {
      console.warn('Custom validation: Could not find input or error message.');
      return;
    }

    // --- Real-time validation function (no change) ---
    function validateInput() {
      if (!customInput.checkValidity()) {
        errorMsg.style.display = 'block';
        customInput.style.borderColor = '#d9534f';
        customInput.style.boxShadow = '0 0 0 1px #d9534f';
        return false;
      } else {
        errorMsg.style.display = 'none';
        customInput.style.borderColor = '#ccc';
        customInput.style.boxShadow = 'none';
        return true;
      }
    }

    // --- Add event listeners (no change) ---
    customInput.addEventListener('input', validateInput);

    productForm.addEventListener('submit', function (event) {
      if (!validateInput()) {
        event.preventDefault(); // Stop the 'Add to Cart'
      }
    });
  });
</script>
