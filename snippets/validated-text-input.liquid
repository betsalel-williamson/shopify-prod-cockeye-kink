{%- comment %}
  1. Create unique IDs for all elements.
{%- endcomment %}
{%- assign form_id = "product-form-" | append: section.id -%}
{%- assign input_id = "custom-engraving-" | append: section.id -%}
{%- assign error_id = "engraving-error-" | append:section.id -%}
{%- assign button_id = "ProductSubmitButton-" | append: section.id -%}

<div style="margin-bottom:15px;">
  <label for="{{ input_id }}">Engraving (1-5 chars, A-Z, 0-9):</label>
  
  <input 
    type="text" 
    id="{{ input_id }}" 
    name="properties[Engraving]"
    maxlength="5"
    pattern="[a-zA-Z0-9]*"
    
    {%- comment %}
      NEW: 'required' attribute ensures the field cannot be empty.
    {%- endcomment %}
    required 
    
    title="Only letters (A-Z) and numbers (0-9) are allowed."
    style="width: 100%; border: 1px solid #ccc; padding: 8px; border-radius: 4px; box-sizing: border-box;"
    form="{{ form_id }}"
  >

  <div id="{{ error_id }}" style="color: #d9534f; display: none; margin-top: 5px; font-size: 0.9em;">
    Please use 1-5 characters (letters and numbers only).
  </div>
</div>

<script>
// Wait for the entire HTML document to be loaded and parsed
document.addEventListener('DOMContentLoaded', function() {
  
  // Get the unique IDs
  const formId = "{{ form_id }}";
  const inputId = "{{ input_id }}";
  const errorId = "{{ error_id }}";
  const buttonId = "{{ button_id }}";
  
  // Find all the elements
  const productForm = document.getElementById(formId);
  const customInput = document.getElementById(inputId);
  const errorMsg = document.getElementById(errorId);
  const submitButton = document.getElementById(buttonId);
  
  // Check if all elements were found
  if (!productForm || !customInput || !errorMsg || !submitButton) {
    console.warn('Custom validation: Could not find all required elements.');
    return;
  }

  // --- Real-time validation function ---
  function validateInput() {
    // checkValidity() will now fail if it's empty OR if the pattern/maxlength is wrong
    if (!customInput.checkValidity()) {
      errorMsg.style.display = 'block';
      customInput.style.borderColor = '#d9534f';
      customInput.style.boxShadow = '0 0 0 1px #d9534f';
      
      submitButton.disabled = true;
      submitButton.style.opacity = '0.5';
      
      return false;
    } else {
      errorMsg.style.display = 'none';
      customInput.style.borderColor = '#ccc';
      customInput.style.boxShadow = 'none';
      
      submitButton.disabled = false;
      submitButton.style.opacity = '1';
      
      return true;
    }
  }

  // --- Add event listeners ---
  customInput.addEventListener('input', validateInput);
  
  productForm.addEventListener('submit', function(event) {
    if (!validateInput()) {
      event.preventDefault();
    }
  });

  {%- comment %}
    NEW: Disable the button on page load.
    The 'required' attribute makes the empty field invalid by default.
  {%- endcomment %}
  submitButton.disabled = true;
  submitButton.style.opacity = '0.5';

  // Optional: If the input ever has a pre-filled (valid) value,
  // run the check once to enable the button.
  if (customInput.value.length > 0) {
    validateInput();
  }

});
</script>
